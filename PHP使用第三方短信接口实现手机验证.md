# PHP使用第三方短信接口实现手机验证

## 1.先去第三方平台注册发开者账号

## 2.下载第三方API接口，并查看使用demo或使用文档

## 3.开始接口编程

### 实现短信验证码的步骤：

前端：

1.获取用户输入的手机号使用AJAX向PHP发送请求，需要将手机号作为参数协带过去

服务器端：

1.封装第三方短信接口，以方便使用

2.判断是否是AJAX请求

3.接收AJAX发送过来的手机号

4.随机生成4位验证码，值范围：1000-9999

5.使用封装好的短信发送函数向此手机号发送4位随机码

6.判断短信函数返回的数据，是否发送成功

成功：

​	1.成功将手机号+随机码与加密盐拼接使用md5或sha1等之类的加密函数加密，生成一个令牌token

​	2.将此令牌存入cookie中并设置其有效期，一般为5分钟

​	3.构建一个成功信息返回给AJAX，格式一般是数组转json如:

```php
echo json_encode([
					'code' => 200,
					'msg' => '短信验证码发送成功！'
				]);
```

失败：

1.失败将不做任何操作，只返回一个错误信息

```php
echo json_encode([
					'code' => -1,
					'msg' => '短信验证码发送失败！'
				]);
```

前端：

此时用户收到了短信验证码，在输入框中输入验证码，这里的处理方式有两种：

一、还是使用AJAX实现无刷新验证用户输入的验证码是否正确

二、等用户按了提交按钮提交表单到PHP处理页

这两种方法的验证处理逻辑是一样的，只是提交数据的方式不一样，下面说下具体验证逻辑是怎样实现的

1.PHP判断数据是那种请求

2.判断之前存入cookie中的4位随机验证码是否过期，也主是cookie是否过期

过期：

```php
//如果是ajax请求则返回如下信息
echo json_encode([
					'code' => -1,
					'msg' => '短信验证码过期！请重新发送'
				]);
			exit;//结束后面的执行
/*************************************************************************/
//如果是post请求则返回如下信息,这是在使用TP5框架的情况下
$this->errro('短信验证码过期!请重新发送');
```

未过期：

3.接收提交过来的验证码

4.对验证码拼接统一的加密盐+手机号进行md5或sha1等加密后生成一个新的令牌newToken

5.将新令牌与存在cookie里的令牌比较

一致：

```php
//如果是ajax请求则返回如下信息
echo json_encode([
					'code' => 200,
					'msg' => '短信验证码正确！'
				]);
			exit;//结束后面的执行
/*************************************************************************/

//如果是post请求则返回如下信息,这是在使用TP5框架的情况下
//验证正确继续执行下面的代码
......

```

不一致：

```php
//如果是ajax请求则返回如下信息
echo json_encode([
					'code' => -1,
					'msg' => '短信验证码错误！'
				]);
			exit;//结束后面的执行
/*************************************************************************/
//如果是post请求则返回如下信息,这是在使用TP5框架的情况下
$this->errro('短信验证码错误');
```

至此短信验证码可以说是完成了，接下来在做个优化

防止用户频繁点击按钮获取验证码，这个优化只要在前端做就好了

```html
<script>
$("#getCodeBtn").click(function(){
		//设置用户频繁点击获取验证码按钮
		//定义时间60秒
		var t = 60;
		//定义一个禁用获取验证码的函数
		function disabledPhoneCode(){
			if(t > 0){
				setTimeout(function(){
					$("#getCodeBtn").attr('disabled',true).val(t+'秒后重新发送验证码');  //禁用
					t--;
					disabledPhoneCode();
				},1000);
			}else{
				$("#getCodeBtn").attr('disabled',false).val('获取验证码');  //启用
				return;  //退出函数
			}
			
		}
}
</script>
```

主要就是当用户点击获取验证码时，当成功发送了验证码就禁用获取验证码按钮，时间一般设置为60后才能在次获取验证码

**==关键点：==**

为了防止用户获取验证码后使用别的手机注册，我们使用了==**手机号+生成的验证码+统一加密盐**==进行md5或hsa1加密，这样就将此手机号与生成的验证绑定在一起了

获取手机验证码时：生成的令牌token:==**手机号+生成的验证码+统一加密盐**==

验证手机验证码时：生成的令牌newToken:==**手机号+用户输入的验证码+统一加密盐**==

只要将这两个令牌一比对就能判断用户的手机号与验证码的正确性

